---
title: "Filter panel for developers"
author: "NEST Core Dev Team"
date: "10/07/2023"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Filter panel for developers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Filter-panel API

### Getting and setting filter states

All filter panel classes have dedicated methods to set and get current filter state.
These methods include:
- `get_filter_state` - returns current state of filters in form of `teal_slices` object.
- `set_filter_state` - adds or modifies state of filters based on `teal_slices` object.
- `remove_filter_state` - removes particular filter states based on `teal_slices` object.
- `clear_filter_states` - removes all filter states.

Setting and getting filter states are done through `teal_slices` object which is a collection of
`teal_slice` objects. Each `teal_slice` object contains a necessary information to:
1. Determine column in the object on which filter expression should be applied on. This includes:
   - `dataname` - name of the dataset
   - `varname` - name of the column
   - `experiment` - only for `MultiAssayExperiment` objects, name of the experiment.
   - `arg` - only for `MultiAssayExperiment` objects, name of the argument in `subset` call.
2. Control behavior and appearance of the `FilterState` module:
   - `choices` - determines set of values from which user can select from.
   - `multiple` - determines if multiple values can be selected (only for `ChoiceFilterState`).
   - `fixed` - determines if values of `teal_slice` can be changed.
   - `locked` - determines of `teal_slice` can be removed.
   - `title` - displayed title of the filter card.
3. Store current filter state values. This includes:
   - `selected` - current values selection
   - `keep_inf` - determines if `Inf` values should be kept in the dataset.
   - `keep_na` - determines if `NA` values should be kept in the dataset.
   - `expr` - explicit logical expression.

Additionally all `teal_slice` objects have unique `id`. It's not possible to initialize more than 
one `FilterState` objects with duplicated `teal_slice` `id`.

To tell `FilteredData` to set a filter for a specific column, then `set_filter_state` method should be
called with `teal_slices` object containing `teal_slice` referring to variable of interest.
To remove particular `FilterState` object then `remove_filter_state` method should be called with
the same `teal_slices` settings.


1. Setting the filter state
```{r, message=FALSE, warning=FALSE}
library(teal.slice)

datasets <- init_filtered_data(
  list(
    iris = list(dataset = iris),
    mtcars = list(dataset = mtcars)
  )
)

set_filter_state(
  datasets = datasets,
  filter = teal_slices(
    teal_slice(dataname = "iris", varname = "Species", selected = "virginica", keep_na = FALSE),
    teal_slice(dataname = "mtcars", id = "4 cyl", title = "4 Cylinders", expr = "cyl == 4"),
    teal_slice(dataname = "mtcars", varname = "mpg", selected = c(20.0, 25.0), keep_na = FALSE, keep_inf = FALSE),
    include_varnames = list(iris = c("Species", "Sepal.Length")),
    exclude_varnames = list(mtcars = "cyl")
  )
)
```

1. Getting the filter state
```{r, message=FALSE, warning=FALSE}
get_filter_state(datasets)
```

1. Removing filter states
```{r, message=FALSE, warning=FALSE}
remove_filter_state(
  datasets = datasets,
  filter = teal_slices(
    teal_slice(dataname = "iris", varname = "Species")
  )
)
```

1. Updating filter states. *Works only in the shiny reactive context.
```{r, message=FALSE, warning=FALSE}
set_filter_state(
  datasets = datasets,
  filter = teal_slices(
    teal_slice(dataname = "mtcars", varname = "mpg", selected = c(22.0, 25.0))
  )
)
```

1. Clear the filter state
```{r, message=FALSE, warning=FALSE}
clear_filter_states(datasets)
```

### Controlling settings of the filter panel

Except controlling individual filter states through `set_filter_state`, one can also set some general settings
of the whole filter panel. This can be done by specific arguments of the `teal_slices` function:

1. `include_varnames` to define which columns from used datasets are allowed to be filtered. In following example
only two columns from `iris` and two columns from `mtcars` will be possible to use as filters. 
```{r}
set_filter_state(
  datasets,
  teal_slices(
    include_varnames = list(
      iris = c("Species", "Sepal.Length"),
      mtcard = c("cyl", "mpg")
    )
  )
)
```

2. `exclude_varnames` to define which columns from used datasets are excluded from possible to filter variables.
In following example all variables except these four will be available to choose from.
```{r}
set_filter_state(
  datasets,
  teal_slices(
    exclude_varnames = list(
      iris = c("Species", "Sepal.Length"),
      mtcard = c("cyl", "mpg")
    )
  )
)
```
3. `count_type` to define type of the counts displayed in a filter card

| "none" | "all" |
|--------|-------|
| Distribution in unfiltered data | Unfiltered vs. filtered distribution  |
| ![](./images/filter_panel/count_type_none.jpeg){width=300} | ![](./images/filter_panel/count_type_all.jpeg){width=300} |

1. `module_add` determines whether "Add Filter Variables" module will be displayed - user won't be able to new filters.



## Filter panel as a module

All instructions described in this vignette can be utilized to build a shiny app.

```{r}
library(shiny)

# initializing FilteredData
datasets <- init_filtered_data(
  list(
    iris = list(dataset = iris),
    mtcars = list(dataset = mtcars)
  )
)

# setting initial filters
set_filter_state(
  datasets = datasets,
  filter = teal_slices(
    teal_slice(dataname = "iris", varname = "Species", selected = "virginica", keep_na = FALSE),
    teal_slice(dataname = "mtcars", id = "4 cyl", title = "4 Cylinders", expr = "cyl == 4"),
    teal_slice(dataname = "mtcars", varname = "mpg", selected = c(20.0, 25.0), keep_na = FALSE, keep_inf = FALSE),
    include_varnames = list(iris = c("Species", "Sepal.Length")),
    exclude_varnames = list(mtcars = "cyl"),
    count_type = "all",
    module_add = TRUE
  )
)

app <- shinyApp(
  ui = fluidPage(
    shinyjs::useShinyjs(),
    fluidRow(
      column(
        width = 9,
        id = "teal_primary_col",
        shiny::tagList(
          actionButton("add_species_filter", "Set iris$Species filter"),
          actionButton("remove_species_filter", "Remove iris$Species filter"),
          actionButton("remove_all_filters", "Remove all filters"),
          verbatimTextOutput("rcode"),
          verbatimTextOutput("filter_state")
        )
      ),
      column(
        width = 3,
        id = "teal_secondary_col",
        datasets$ui_filter_panel("filter_panel")
      )
    )
  ),
  server = function(input, output, session) {
    # calling filter panel module
    datasets$srv_filter_panel("filter_panel")

    # displaying actual filter states
    output$filter_state <- renderPrint(print(get_filter_state(datasets), trim = FALSE))

    # displaying reproducible filter call
    output$rcode <- renderText(
      paste(
        sapply(c("iris", "mtcars"), datasets$get_call),
        collapse = "\n"
      )
    )

    # programmatic interaction with FilteredData
    observeEvent(input$add_species_filter, {
      set_filter_state(
        datasets,
        teal_slices(
          teal_slice(dataname = "iris", varname = "Species", selected = c("setosa", "versicolor"))
        )
      )
    })

    # programmatic removal of the FilterState
    observeEvent(input$remove_species_filter, {
      remove_filter_state(
        datasets,
        teal_slices(
          teal_slice(dataname = "iris", varname = "Species")
        )
      )
    })
    observeEvent(input$remove_all_filters, clear_filter_states(datasets))
  }
)
if (interactive()) {
  runApp(app)
}
```
