<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="teal.slice">
<title>teal.slice classes • teal.slice</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="teal.slice classes">
<meta property="og:description" content="teal.slice">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><link rel="stylesheet" href="../consent.css">
<script src="../consent.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">teal.slice</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0.9011</small>

    <div style="width: 140px; margin-left: 0.5rem;"> <small class="nav-text text-muted me-auto">part of</small> <img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/nest.png?raw=true" alt="NEST" style="height: 30px;"><a href="https://pharmaverse.org/" class="external-link"><img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/pharmaverse.png?raw=true" alt="pharmaverse" style="height: 28px;"></a> </div>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/teal-slice.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/filter-panel-for-developers.html">Filter panel for developers</a>
    <a class="dropdown-item" href="../articles/teal-slice-classes.html">teal.slice classes</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<!-- start dropdown for versions --> <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle"
          data-bs-toggle="dropdown" role="button"
          aria-expanded="false" aria-haspopup="true"
          id="dropdown-versions">Versions</a> <div class="dropdown-menu" aria-labelledby="dropdown-versions"> <a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/teal.slice/main">main</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/teal.slice/latest-tag">latest-tag</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/teal.slice/v0.3.0">v0.3.0</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/teal.slice/v0.2.0">v0.2.0</a> </div></li>
<!-- end dropdown for versions -->
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-reports">Reports</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-reports">
    <a class="dropdown-item" href="../coverage-report/">Coverage report</a>
    <a class="dropdown-item" href="../unit-test-report/">Unit test report</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/insightsengineering/teal.slice">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>teal.slice classes</h1>
                        <h4 data-toc-skip class="author">NEST Core Dev
Team</h4>
            
            <h4 data-toc-skip class="date">10/07/2023</h4>
      
      
      <div class="d-none name"><code>teal-slice-classes.Rmd</code></div>
    </div>

    
    
<p>This vignette provides a deep dive into the design of the
<code>teal.slice</code> package. It is intended for advanced developers.
If you want to merely use <code>teal.slice</code>, the <em>Filter panel
for developers</em> vignette should satisfy all your needs.</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>teal.slice</code> package is composed of multiple classes,
whose primary purpose is to provide a <code>shiny</code> module for
managing and displaying filters. The top class in the structure is
<code>FilteredData</code>. Other modules in the app can interact with
<code>FilteredData</code> to make filter calls and obtain filtered
data.</p>
<p><img src="images/filter_panel/filter_panel_uml_all.jpg" width="100%"></p>
<p>The <code>FilteredData</code> object contains one or more
<code>FilteredDataset</code> objects. While <code>FilteredData</code>
manages the entire filter panel, each <code>FilteredDataset</code> is
responsible for filtering a single data set.
<code>FilteredDataset</code> contains one or more
<code>FilterStates</code> objects, each corresponding to one data
structure like a <code>data.frame</code>, a
<code>SummarizedExperiment</code>, or a
<code>MultiAssayExperiment</code>. <code>FilterStates</code> holds a
collection of <code>FilterState</code> objects, each representing a
single filter condition applied on one variable.</p>
<p><code>FilterStates</code> can also hold <code>FilterStateExpr</code>
objects. This is a variation of <code>FilterStates</code> that focuses
on the filter expression regardless of the underlying data. The
expression can refer to one or several variables.</p>
<p><code>FilteredData</code>, <code>FilteredDataset</code>,
<code>FilterStates</code>, and
<code>FilterState</code>/<code>FilterStateExpr</code> are all
<code>R6</code> classes and objects of those classes form a hierarchy
but there is no inheritance between them.</p>
<p>Each <code>FilterState</code>/<code>FilterStateExpr</code> object
contains one <code>teal_slice</code> object. <code>teal_slice</code>
stores all information necessary to define a filter. It is not an
<code>R6</code> class, it does not have any innate methods or behaviors
and does not produce any <code>shiny</code> modules. Its sole purpose is
to store filter information.</p>
</div>
<div class="section level2">
<h2 id="initialization">Initialization<a class="anchor" aria-label="anchor" href="#initialization"></a>
</h2>
<p><img src="images/filter_panel/filtered_data_init.jpg" width="100%"></p>
<p>As part of the <code>teal</code> workflow, <code>FilteredData</code>,
<code>FilteredDataset</code>, and <code>FilterStates</code> are created
instantly when the data is loaded and remain unchanged. One
<code>FilteredData</code> object is initialized on
<code>TealData</code>. A <code>FilteredDataset</code> is initialized for
each data set. One or more <code>FilterStates</code> are initialized,
depending on the type of data set.</p>
<p>On the other hand, a <code>FilterState</code> is initialized each
time a new filter is added. The values of the <code>FilterState</code>
can be changed, and it can also be removed and added again.</p>
<p>The key mechanism in the new filter panel is in
<code>FilterStates</code> class. One can think of
<code>FilterStates</code> as equivalent to a single, possibly compound,
subset call made on one data structure. While <code>FilterState</code>
represents a logical predicate on one vector, e.g
<code>SEX == "F"</code>, <code>FilterStates</code> will compose all
predicates of its member <code>FilterState</code> objects into a call to
a subsetting function,
e.g. <code>data &lt;- subset(data, SEX == "F" &amp; RACE == "CAUCASIAN")</code>.</p>
<p>In the case of a <code>data.frame</code>, a single
<code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter</a></code> call is sufficient to subset the whole data
set. A <code>MultiAssayExperiment</code> on the other hand contains
patient data in the <code>@colData</code> slot and multiple experiments
in the <code>@ExperimentList</code> slot, and all of these objects have
to be filtered by separate subsetting calls. Therefore, subclasses of
<code>FilterStates</code> exist to handle different kinds of data
structures and they use different subsetting functions.</p>
</div>
<div class="section level2">
<h2 id="class-description">Class Description<a class="anchor" aria-label="anchor" href="#class-description"></a>
</h2>
<p>This section provides a detailed description of all classes that make
up the filter panel structure.</p>
<div class="section level3">
<h3 id="filtereddata">
<code>FilteredData</code><a class="anchor" aria-label="anchor" href="#filtereddata"></a>
</h3>
<p><img src="images/filter_panel/class_details_filtered_data.jpg" width="33%"></p>
<p><code>FilteredData</code> is an object responsible for managing the
filter panel. It sits on top of the class structure and handles the
<code>shiny</code> modules of the subclasses.</p>
<p><code>FilteredData</code> provides several API methods that can be
used to access reproducible subsetting calls and the resulting filtered
data. It also allows external modules to manage filter states through
functions such as <code>get_filter_state</code>,
<code>set_filter_state</code>, <code>remove_filter_state</code>, and
<code>clear_filter_state</code>.</p>
</div>
<div class="section level3">
<h3 id="filtereddataset">
<code>FilteredDataset</code><a class="anchor" aria-label="anchor" href="#filtereddataset"></a>
</h3>
<p><img src="images/filter_panel/class_details_filtered_dataset.jpg" width="33%"></p>
<p><code>FilteredDataset</code> is a class that keeps unfiltered data
and returns filtered data based on the filter call derived from the
contained <code>FilterStates</code>. <code>FilteredDataset</code> class
objects are initialized by <code>FilteredData</code>, one for each data
set. <code>FilteredDataset</code> contains a single
<code>TealDataset</code> object and one-to-many
<code>FilterStates</code> depending on the type of that object.
<code>FilteredDataset</code> stores data set attributes, joins keys to
other data sets, and also combines and executes the subsetting calls
taken from <code>FilterStates</code>.</p>
<p>The following <code>FilteredDataset</code> child classes are
currently implemented:</p>
<ul>
<li>
<code>DefaultFilteredDataset</code> for
<code>data.frame</code>.</li>
<li>
<code>MAEFilteredDataset</code> for
<code>MultiAssayExperiment</code>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="filterstates">
<code>FilterStates</code><a class="anchor" aria-label="anchor" href="#filterstates"></a>
</h3>
<p><img src="images/filter_panel/class_details_filter_states.jpg" width="33%"></p>
<p>When the app starts, <code>FilteredDataset</code> initializes one or
more <code>FilterStates</code> objects, one for each component of the
underlying data set. Every <code>FilterStates</code> object is
responsible for making one subset call. For example, a
<code>MAEFilteredDataset</code> will create one
<code>FilterStates</code> for its <code>colData</code> and one
<code>FilterStates</code> for each of its experiments. Every
<code>FilterStates</code> will return a separate subsetting call, which
will be used to subset the entire <code>MultiAssayExperiment</code>.</p>
<p>The following <code>FilteredDataset</code> child classes are
currently implemented:</p>
<ul>
<li>
<code>DFFilterStates</code> for <code>data.frame</code>; uses
<code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter</a></code> to filter on columns.</li>
<li>
<code>MAEFilterStates</code> for<code>MultiAssayExperiment</code>;
uses <code><a href="http://waldronlab.io/MultiAssayExperiment/reference/subsetBy.html" class="external-link">MultiAssayExperiment::subsetByColData</a></code> to filter on
columns of the <code>DataFrame</code> in the <code>@colData</code>
slot.</li>
<li>
<code>SEFilterStates</code> for <code>SummarizedExperiment</code>;
uses the <code>subset</code> method for
<code>SummarizedExperiment</code> to filter on columns of
<code>DataFrames</code> in the <code>@colData</code> and
<code>@rowData</code> slots.</li>
<li>
<code>MatrixFilterStates</code> for <code>matrix</code>; uses the
<code>[</code> operator to filter on columns.</li>
</ul>
<p><code>FilterStates</code> serves two <code>shiny</code>-related
purposes:</p>
<ul>
<li><p><code>ui/srv_add</code> allows adding a <code>FilterState</code>
for a selected variable. The variables included in the module are the
filterable column names of the provided data set. Selecting a variable
adds a <code>FilterState</code> to the <code>reactiveVal</code> stored
in the <code>private$state_list</code> private field. The subtype of the
created <code>FilterState</code> automatically determined based on the
class of the selected column.</p></li>
<li><p><code>ui/srv_active</code> displays cards of the currently
existing <code>FilterState</code> objects. Every
<code>FilterState</code> object serves a remove button and
<code>FilterStates</code> reacts to clicking that button by removing the
respective <code>FilterState</code> from <code>private$state_list</code>
and destroying it’s observers. <code>ui/srv_active</code> also contains
a remove button that removes all <code>FilterState</code> objects within
this <code>FilterStates</code>.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="filterstate">
<code>FilterState</code><a class="anchor" aria-label="anchor" href="#filterstate"></a>
</h3>
<p><img src="images/filter_panel/class_details_filter_state.jpg" width="33%"></p>
<p>This class controls a single filter card and returns a condition call
that depends on the selection state. A <code>FilterState</code> is
initialized each time <code>FilterStates</code> adds a new filter.
Different classes of data require different handling of choices so
several <code>FilterState</code> subclasses exist and each of them
presents a different user interface and generates a different subsetting
call. A <code>FilterState</code> is created as follows:</p>
<ol style="list-style-type: decimal">
<li>
<code>FilterStates</code> creates <code>teal_slice</code> with
<code>dataname</code> based on the parent data set and
<code>varname</code> based on the selected variable</li>
<li>the <code>teal_slice</code> is wrapped in <code>teal_slices</code>
and passed to <code>FilterStates$set_filter_state</code>
</li>
<li>
<code>FilterStates$set_filter_state_impl</code> is called</li>
<li>
<code>FilterStates$set_filter_state_impl</code> calls
<code>init_filter_state</code>, passing the appropriate variable as
<code>x</code>
</li>
<li>
<code>init_filter_states</code> is a generic function that
dispatches <code>x</code>, <code>teal_slice</code> and other arguments
to the respective child class constructor:</li>
</ol>
<ul>
<li>
<code>LogicalFilterState</code> for <code>logical</code> variables.
Presents a checkbox group. Call example: <code>!variable</code>.</li>
<li>
<code>RangeFilterState</code> for <code>numeric</code> variables.
Presents an interactive plot as well as two numeric inputs. Selection
are always two values that represent inclusive interval limits. Call
example:
<code>variable &gt;= selection[1] &amp; variable &lt;= selection[2]</code>
</li>
<li>
<code>DateFilterState</code> for <code>Date</code> variables.
Presents two date inputs. Selection is two values that determine
inclusive interval limits. Call example:
<code>variable &gt;= selection[1] &amp; variable &lt;= selection[2]</code>.</li>
<li>
<code>DatetimeFilterState</code> for <code>POSIXct</code> and
<code>POSIXlt</code> variables. Similar to
<code>DateFilterState</code>.</li>
<li>
<code>ChoicesFilterState</code> for <code>character</code> and
<code>factor</code> values. Additionally, all classes will be passed to
<code>ChoicesFilterState</code> if their number of unique values is
lower than that in
<code>getOption("teal.threshold_slider_vs_checkboxgroup")</code>.
Presents either a checkbox group or a drop-down menu. Depending on
settings, allows either only one or any number of values to be selected.
Call examples: <code>variable == selection</code>,
<code>variable %in% selection</code>.</li>
<li>
<code>EmptyFilterState</code> for variables that contain only
missing values. Does not return calls.</li>
</ul>
<p>All child classes handle missing values, and
<code>RangedFilterState</code> also handles infinite values.</p>
<p>The <code>FilterState</code> constructor also takes the
<code>extract_type</code> argument, which determines how the call is
constructed <code>extract_type</code> can be unspecified,
<code>"matrix"</code> or <code>"list"</code> and its value corresponds
to the type of the variable prefix in the returned condition call. If
<code>extract_type</code> is <code>"list"</code>, the variable in the
condition call is <code>&lt;dataname&gt;$&lt;varname&gt;</code>, while
for <code>"matrix"</code> it would be
<code>&lt;dataname&gt;[, "&lt;varname&gt;"]</code>.</p>
</div>
<div class="section level3">
<h3 id="filterstateexpr">
<code>FilterStateExpr</code><a class="anchor" aria-label="anchor" href="#filterstateexpr"></a>
</h3>
<p><img src="images/filter_panel/class_details_filter_state_expr.jpg" width="33%"></p>
<p>Similarly to <code>FilterState</code>, <code>FilterStateExpr</code>
controls a single filter card and returns logical expression. However,
while <code>FilterState</code> generates the call based on the selection
state, in <code>FilterStateExpr</code> the call must be specified
manually and it must be a valid R expression.</p>
</div>
<div class="section level3">
<h3 id="teal_slice">
<code>teal_slice</code><a class="anchor" aria-label="anchor" href="#teal_slice"></a>
</h3>
<p><img src="images/filter_panel/class_details_teal_slice.jpg" width="33%"></p>
<p><code>teal_slice</code> is a simple object for storing filter
information. It can be thought of as a quantum of information. A
<code>teal_slice</code> object is passed directly to
<code>FilterState$initialize</code> and is stored inside of the
<code>FilterState</code> to keep the current state of the filter.
Technically, all values used to generate a call are in
<code>teal_slice</code>. <code>FilterState</code> can be described as a
wrapper around <code>teal_slice</code> that provides additional methods
to handle filter state. It also contains the actual data (a single
column).</p>
<p>While <code>teal_slice</code> is not an <code>R6</code> object and
does not encode any behaviors, it is implemented around a
<code>reactiveValues</code> object to allow shared state in advanced
<code>teal</code> applications.</p>
<p>See <code><a href="../reference/teal_slice.html">?teal_slice</a></code> for a detailed explanation.</p>
</div>
</div>
<div class="section level2">
<h2 id="making-a-reproducible-filter-call">Making a reproducible filter call<a class="anchor" aria-label="anchor" href="#making-a-reproducible-filter-call"></a>
</h2>
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p><img src="images/filter_panel/get_call_overview.jpg" width="100%"></p>
<p>The diagram above presents the filter panel classes and their
responsibilities when composing filter calls. Code is generated by
nested execution of <code>get_call</code> methods.</p>
<p><code>FilteredData$get_call</code> calls
<code>FilteredDataset$get_call</code>, which calls
<code>FilterStates$get_call</code> which in turn calls
<code>FilterState$get_call</code>.</p>
<p><code>FilterState$get_call()</code> returns a single subsetting
expression (logical predicate).</p>
<p><code>FilterStates$get_call()</code> returns a single complete
subsetting call by extracting expressions from all
<code>FilterState</code> objects and combining them with the
<code>&amp;</code> operator.</p>
<p><code>FilteredDataset$get_call()</code> returns a list of calls
extracted from all <code>FilterStates</code> objects.</p>
<p><code>FilteredData$get_call(&lt;dataname&gt;)</code> returns a list
of calls extracted from the specified <code>FilteredDataset</code>.</p>
</div>
<div class="section level3">
<h3 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<p><img src="images/filter_panel/get_call_example.jpg" width="100%"></p>
<p>Calling <code>datasets$get_call(&lt;dataname&gt;)</code> in
<code>teal</code> modules executes a chain of calls in all filter panel
classes. Consider the following scenario:</p>
<ol style="list-style-type: decimal">
<li><p><code>FilteredData</code> contains three data sets:
<code>ADSL</code>, <code>ADTTE</code>, <code>MAE</code>, each stored in
its own <code>FiteredDataset</code> object</p></li>
<li><p><code>ADSL</code> is a <code>data.frame</code> so it can be
filtered with a single <code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter</a></code> call. This data set is
stored in <code>DefaultFilteredDataset</code>, which holds a single
<code>FilterStates</code> object.</p></li>
<li><p><code>FilterStates</code> constructs a <code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter</a></code>
call based on the <code>FilterState</code> objects present in its
<code>private$state_list</code>.</p></li>
<li><p>When <code>FilterStates$set_filter_state</code> adds a new
<code>teal_slice</code>, a <code>FilterState</code> is created and added
to <code>private$state_list</code> in <code>FilterStates</code>.
<code>FilterStates</code> gathers logical expressions from all of its
<code>FilterState</code> objects and composes them into a
<code>dplyr::filter(ADSL, ...)</code> call.</p></li>
<li><p>Two new filters have been added: <code>SEX</code> and
<code>AGE</code>. This causes initialization of appropriate
<code>FilterState</code> subclasses: <code>ChoiceFilterState</code> and
<code>RangeFilterState</code>. Each <code>FilterState</code> produces a
subsetting expression: <code>SEX == "F"</code> and
<code>AGE &gt;= 20 &amp; AGE &lt;= 60</code>. The expressions are
combined with <code>&amp;</code> and passed to
<code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter</a></code>, producing
<code>ADSL &lt;- dplyr::filter(ADSL, SEX == "F" &amp; AGE &gt;= 20 &amp; AGE &lt;= 60)</code>.
<code>DefaultFilteredDataset</code> puts this call in a list and returns
it to <code>FilteredData</code>.</p></li>
<li><p><code>ADTTE</code> is also a <code>data.frame</code> so the
<code>FilteredDataset</code> that stores it works much the same as the
one for <code>ADSL</code>. The one difference is that the
<code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter</a></code> call for <code>ADTTE</code> is followed by an
<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">dplyr::inner_join</a></code> call to merge the filtering result with
the parent data set (<code>ADSL</code>) so that key columns remain
consistent. Note that this only done when <code>join_keys</code> is
specified - otherwise <code>ADTTE</code> would be treated as a separate
data set and filtered independently.</p></li>
<li><p>The <code>MAE</code> data set is a
<code>MultiAssayExperiment</code>, which contains multiple sub-objects
which can be filtered on. One of them is <code>ADSL</code>-like patient
data, stored as a <code>DataFrame</code> in <code>MAE@colData</code>,
and others are experiments, typically <code>SummarizedExperiment</code>
objects, stored in <code>MAE@ExperimentList</code>, which can be
extracted using <code>MAE[["experiment name"]]</code>. Therefore,
<code>FilteredDatasetMAE</code> has multiple <code>FilterStates</code>
objects: one for subject data and one for each experiment.</p></li>
<li><p>A <code>MAEFilterStates</code> object is initialized for subject
data and for this object
<code><a href="http://waldronlab.io/MultiAssayExperiment/reference/subsetBy.html" class="external-link">MultiAssayExperiment::subsetByColData</a></code> function is applied.
<code><a href="http://waldronlab.io/MultiAssayExperiment/reference/subsetBy.html" class="external-link">MultiAssayExperiment::subsetByColData</a></code> has two arguments:
<code>x</code> (data) and <code>y</code> (conditions). Since all filter
expressions are passed to one argument, <code>MAEFilterStates</code>
only has one <code>state_list</code>, just like
<code>DFFilterStates</code>. Adding new filters triggers the same
actions as described in (4).</p></li>
<li><p>A <code>SummarizedExperiment</code> is more complicated as
observations can be filtered based on its <code>rowData</code> and
<code>colData</code> slots, both contain <code>DataFrame</code>s.
Subsetting is done by a dedicated S4 <code>subset</code> method, which
takes two key arguments: <code>subset</code> takes logical expressions
that will be applied to <code>rowData</code> and <code>select</code>
takes logical expressions that will be applied to <code>colData</code>.
<code>teal_slice</code> objects that specify filters in a
<code>SummarizedExperiment</code> must contain an <code>arg</code>
element, either <code>"subset"</code> or <code>"select"</code>, to
reflect which slot of the experiment they refer to. The
<code>SEFilterStates</code> gathers logical expressions its member
<code>FilterState</code> objects, groups them by the <code>arg</code>
element, and builds a call so <code>subset</code> with two combined
logical expressions passed to the <code>subset</code> and
<code>select</code> arguments.</p></li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="filter-panel-modules">Filter panel modules<a class="anchor" aria-label="anchor" href="#filter-panel-modules"></a>
</h2>
<p>The <code>FilteredData</code> object uses the
<code>filter_panel_ui</code> and <code>filter_panel_srv</code> methods
to put up a filter panel that can be used in any application. In
<code>teal</code> applications it will be placed on the right hand side.
The filter panel module does not return anything. Data, subsetting calls
and filter states are accessible by specific public methods:
<code>get_data</code>, <code>get_call</code>, and
<code>get_filter_state</code>, respectively. Typically, the filter panel
consists of three modules:</p>
<ul>
<li>
<code>ui/srv_overview</code> displays observation counts filtered vs
unfiltered data</li>
<li>
<code>ui/srv_active</code> displays active filter cards, which are
created by <code>FilterState</code> objects</li>
<li>
<code>ui/srv_add</code> allows for adding filters</li>
</ul>
<p><code>FilteredData</code> does not handle data sets directly because
they may be of different types, rather, it calls respective methods in
lower level classes.</p>
<p>When a new filter is added using the “Add Filter Variable” module in
<code>FilterStates</code>, a new <code>FilterState</code> object is
initialized and added to <code>private$state_list</code>.
<code>FilterStates$srv_active</code> observes
<code>private$state_list</code> (which is a <code>reactiveVal</code>)
and when the state of the list changes (a filter is added added or
removed), it calls <code>FilterState$server</code> and uses
<code>renderUI</code> to display <code>FilterState$ui</code>.</p>
<p><img src="images/filter_panel/filter_panel_modules_call.jpg" width="33%"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="nest">
  <p>teal.slice is a part of the <strong>NEST</strong> and <a href="https://pharmaverse.org/" class="external-link"><strong>pharmaverse</strong></a>.</p>
</div>
<script type="text/javascript" src="../analytics.js"></script></footer>
</div>

  

  

  </body>
</html>
